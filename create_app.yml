---

- hosts: ansible-server
  become: true

  tasks:

    - name: load vars
      include_vars: '{{ item }}'
      with_items:
        - releases/{{ Release }}/all.yml

    - name: copy Dockerfile
      copy:
        src: Dockerfile
        dest: /root/Dockerfile

    - name: create app dir
      file:
        path: /root/app
        state: directory

    - name: copy app/app.py
      copy:
        src: app/app.py
        dest: /root/app/app.py

    - name: copy requirements.txt
      copy:
        src: requirements.txt
        dest: /root/requirements.txt

    - name: remove a container
      docker_container:
        name: flaskapp-{{ version }}
        state: absent

    - name: create docker image
      shell: docker build -t docker-flask:latest .

    - name: run docker with the app
      shell: docker run --name flaskapp-{{ version }} -d -v $PWD/app:/app -p 5000:500-{{ Release }} docker-flask:latest

